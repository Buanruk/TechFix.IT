<?php
// ai_rulebased.php (เวอร์ชันอัปเกรด)
header("Content-Type: application/json; charset=utf-8");

/*
=================================================
 1. ฐานข้อมูลความรู้ (Knowledge Base)
=================================================
 (อัปเกรดตามรูปภาพอุปกรณ์ และอาการเสียที่ส่งมา)
*/
$knowledgeBase = [

    // ===== หมวด Computer / Laptop =====
    [
        "keywords" => ["เปิดไม่ติด", "จอดำ", "ไม่มีไฟ", "กดไม่ติด"],
        "solution" => "อาการ: คอมพิวเตอร์/โน้ตบุ๊ก เปิดไม่ติด\n\nวิธีแก้เบื้องต้น:\n1. (PC) ตรวจสอบปลั๊กไฟว่าเสียบแน่นหรือไม่ ทั้งที่ตัวเครื่องและเต้าเสียบ\n2. (โน้ตบุ๊ก) ลองเสียบสายชาร์จค้างไว้ 15 นาที แล้วลองเปิดใหม่ (แบตอาจจะหมดเกลี้ยง)\n3. (โน้ตบุ๊ก) ลองถอดแบตเตอรี่ออก (ถ้าถอดได้) เสียบสายชาร์จแล้วเปิดโดยตรง\n4. (PC) ตรวจสอบว่าสวิตช์ที่ Power Supply (ด้านหลังเคส) เปิดอยู่หรือไม่ (สัญลักษณ์ 'I' คือเปิด)"
    ],
    [
        "keywords" => ["คอมช้า", "เครื่องช้า", "อืด", "ทำงานช้า", "กระตุก"],
        "solution" => "อาการ: คอมพิวเตอร์/โน้ตบุ๊ก ทำงานช้า\n\nวิธีแก้เบื้องต้น:\n1. ลอง Restart เครื่อง (เริ่มระบบใหม่)\n2. ปิดโปรแกรมที่ไม่ได้ใช้งาน โดยเฉพาะโปรแกรมที่ค้างใน Task Manager (Ctrl+Shift+Esc)\n3. สแกนไวรัสด้วยโปรแกรม Antivirus\n4. ตรวจสอบว่าพื้นที่ 'Drive C:' ใกล้เต็มหรือไม่ หากเต็ม ให้ลบไฟล์ขยะออก"
    ],
    [
        "keywords" => ["ค้างบ่อย", "แฮงค์", "โปรแกรมค้าง"],
        "solution" => "อาการ: คอมพิวเตอร์/โน้ตบุ๊ก ค้างบ่อย\n\nวิธีแก้เบื้องต้น:\n1. ตรวจสอบว่าเครื่องร้อนเกินไปหรือไม่ ลองทำความสะอาดพัดลมระบายอากาศ\n2. อัปเดตไดรเวอร์การ์ดจอและ Windows ให้เป็นเวอร์ชันล่าสุด\n3. ลองสแกนหา Bad Sector ใน Harddisk (คลิกขวา Drive C: > Properties > Tools > Check)"
    ],
    [
        "keywords" => ["ภาพไม่ขึ้น", "จอมืด", "จอไม่ติด", "คอมติดแต่จอไม่ขึ้น"],
        "solution" => "อาการ: คอมทำงาน แต่ภาพไม่ขึ้นจอ\n\nวิธีแก้เบื้องต้น:\n1. ตรวจสอบสายจอ (HDMI/VGA) ว่าเสียบแน่นทั้งฝั่งจอและฝั่งคอมพิวเตอร์\n2. ลองปิด-เปิดจอภาพ (ปุ่ม Power ที่จอ)\n3. (PC) หากมีการ์ดจอแยก ให้แน่ใจว่าเสียบสายจอถูกช่อง (ช่องของการ์ดจอ ไม่ใช่ช่องของเมนบอร์ด)"
    ],
    [
        "keywords" => ["เสียงดังผิดปกติ", "พัดลมดัง", "มีเสียงแปลกๆ"],
        "solution" => "อาการ: มีเสียงดังผิดปกติจากเครื่อง\n\nวิธีแก้เบื้องต้น:\n1. หากดัง 'แกรกๆ' ตลอดเวลา อาจเป็นที่ Harddisk > ให้รีบ Backup ข้อมูลสำคัญทันที\n2. หากดัง 'วี้ดๆ' หรือ 'ฟู่ๆ' อาจเป็นที่พัดลม > ลองเป่าฝุ่นทำความสะอาดช่องระบายอากาศ\n3. ตรวจสอบว่ามีสายไฟภายใน (สำหรับ PC) ไปขัดขวางใบพัดลมหรือไม่"
    ],
    [
        "keywords" => ["ขึ้น Error", "จอฟ้า", "blue screen"],
        "solution" => "อาการ: ขึ้น Error หรือจอฟ้า\n\nวิธีแก้เบื้องต้น:\n1. ลองจดรหัส Error (เช่น 0x000000F) แล้วค้นหาใน Google\n2. ลอง Restart เครื่องใน Safe Mode เพื่อดูว่าเป็นที่ไดรเวอร์หรือโปรแกรมที่เพิ่งติดตั้งหรือไม่\n3. หากเพิ่งติดตั้ง RAM หรืออุปกรณ์ใหม่ ให้ลองถอดออกแล้วเปิดใหม่"
    ],

    // ===== หมวด Printer (ปริ้นเตอร์) =====
    [
        "keywords" => ["ปริ้นไม่ออก", "ปริ้นเตอร์", "สั่งพิมพ์ไม่ได้", "เครื่องพิมพ์", "ปริ้นไม่ติด"],
        "solution" => "อาการ: สั่งพิมพ์งานไม่ออก\n\nวิธีแก้เบื้องต้น:\n1. ตรวจสอบว่าเปิดเครื่องปริ้นเตอร์หรือยัง และไม่มีไฟกระพริบสีส้ม (Error)\n2. ตรวจสอบกระดาษว่ามีพอหรือไม่ หรือกระดาษติดหรือไม่\n3. ตรวจสอบสาย USB ที่เชื่อมต่อกับคอมว่าแน่นดีหรือไม่\n4. ลอง Restart ทั้งคอมพิวเตอร์และปริ้นเตอร์ (ปิด-เปิดใหม่)"
    ],
    [
        "keywords" => ["กระดาษติด", "paper jam"],
        "solution" => "อาการ: กระดาษติดในเครื่องปริ้นเตอร์\n\nวิธีแก้เบื้องต้น:\n1. ปิดเครื่องปริ้นเตอร์\n2. เปิดฝาเครื่อง แล้วค่อยๆ ดึงกระดาษที่ติดออกมา *ในทิศทางเดียวกับที่กระดาษวิ่ง*\n3. (สำคัญ) ตรวจสอบให้แน่ใจว่าไม่มีเศษกระดาษชิ้นเล็กๆ ฉีกขาดติดค้างอยู่ภายใน"
    ],

    // ===== หมวด อุปกรณ์เครือข่าย (Network) =====
    [
        "keywords" => ["ต่อเน็ตไม่ได้", "wifi ไม่ติด", "เน็ตหลุด", "เล่นเน็ตไม่ได้", "ไวไฟ", "อินเทอร์เน็ตหลุด"],
        "solution" => "อาการ: เชื่อมต่ออินเทอร์เน็ตไม่ได้\n\nวิธีแก้เบื้องต้น:\n1. **Restart Router** (ถอดปลั๊ก 1 นาทีแล้วเสียบใหม่) <— ได้ผล 90%\n2. ที่คอมพิวเตอร์ ให้ลอง 'Disconnect' แล้ว 'Connect' Wifi ใหม่อีกครั้ง\n3. ลอง Restart คอมพิวเตอร์ของคุณ\n4. ลองใช้มือถือต่อ Wifi เดียวกันดูว่าเล่นได้หรือไม่ (เพื่อตรวจสอบว่าปัญหาอยู่ที่คอม หรือที่ Router)"
    ],
    [
        "keywords" => ["เน็ตช้า", "เน็ตอืด", "wifi ช้า"],
        "solution" => "อาการ: อินเทอร์เน็ตช้าผิดปกติ\n\nวิธีแก้เบื้องต้น:\n1. ลอง Restart Router (ถอดปลั๊ก 1 นาทีแล้วเสียบใหม่)\n2. ลองขยับเข้าไปใกล้ Router มากขึ้น สัญญาณอาจจะอ่อน\n3. ตรวจสอบว่ามีคนในบ้านกำลังดาวน์โหลดไฟล์ขนาดใหญ่หรือดูวิดีโอ 4K หลายเครื่องพร้อมกันหรือไม่"
    ],

    // ===== หมวด TV (โทรทัศน์) =====
    [
        "keywords" => ["TV ไม่มีสัญญาณ", "ทีวีไม่มีสัญญาณ", "จอดำ"],
        "solution" => "อาการ: TV ไม่มีสัญญาณ\n\nวิธีแก้เบื้องต้น:\n1. ตรวจสอบว่าเสียบสายอากาศ (เสา/จานดาวเทียม) แน่นหรือไม่\n2. กดปุ่ม 'Source' หรือ 'Input' ที่รีโมท ตรวจสอบว่าเลือกช่องสัญญาณถูกต้องหรือไม่ (เช่น HDMI 1, HDMI 2, AV, TV)\n3. หากใช้กล่องรับสัญญาณ (เช่น กล่อง True, AIS) ให้ลองปิด-เปิดกล่องนั้นใหม่"
    ],
    [
        "keywords" => ["TV ภาพไม่ขึ้น", "ทีวีภาพไม่ขึ้น", "ทีวีจอไม่ติด"],
        "solution" => "อาการ: TV ภาพไม่ขึ้น (แต่มีเสียง หรือไม่มีอะไรเลย)\n\nวิธีแก้เบื้องต้น:\n1. ตรวจสอบว่าเสียบปลั๊กทีวีแน่นหรือไม่\n2. หากต่อผ่านกล่อง HDMI ให้ลองเปลี่ยนสาย HDMI หรือสลับช่องเสียบ\n3. ลองกดปุ่ม 'Menu' ที่รีโมท ถ้ามีเมนูขึ้นมา แสดงว่าทีวีไม่เสีย แต่สัญญาณ Input มีปัญหา"
    ],

    // ===== หมวด Speaker (ลำโพง) =====
    [
        "keywords" => ["ลำโพงไฟไม่เข้า", "ลำโพงเปิดไม่ติด"],
        "solution" => "อาการ: ลำโพงไฟไม่เข้า/เปิดไม่ติด\n\nวิธีแก้เบื้องต้น:\n1. ตรวจสอบปลั๊กไฟ หรือสาย USB ที่จ่ายไฟให้ลำโพง\n2. หากเป็นลำโพง Bluetooth ตรวจสอบว่าชาร์จแบตเตอรี่แล้วหรือยัง\n3. หากมีสวิตช์เปิด-ปิด ให้แน่ใจว่าเปิดแล้ว (บางรุ่นเป็นแบบปุ่มหมุน Volume)"
    ],
    [
        "keywords" => ["ลำโพงไม่มีเสียง", "เสียงไม่ออก", "ลำโพงเงียบ"],
        "solution" => "อาการ: ลำโพงไม่มีเสียง (แต่ไฟเข้า)\n\nวิธีแก้เบื้องต้น:\n1. ตรวจสอบว่าเสียบสายแจ็ค 3.5mm (สายหูฟัง) แน่นหรือไม่ ทั้งฝั่งคอมและฝั่งลำโพง\n2. (ในคอม) คลิกที่ไอคอนรูปลำโพงมุมล่างขวา ตรวจสอบว่า 'Mute' (ปิดเสียง) อยู่หรือไม่\n3. (ในคอม) ตรวจสอบว่าเลือกอุปกรณ์ Playback ถูกต้อง (อาจจะเผลอเลือกเป็นจอ Monitor แทนลำโพง)"
    ],
    [
        "keywords" => ["ลำโพงเสียงแตก", "เสียงซ่า", "เสียงจี่"],
        "solution" => "อาการ: ลำโพงเสียงแตก หรือมีเสียงรบกวน\n\nวิธีแก้เบื้องต้น:\n1. ลองขยับสายแจ็ค 3.5mm หรือลองเปลี่ยนสายใหม่\n2. ลองลดเสียงที่คอมพิวเตอร์ลง แล้วไปเร่งเสียงที่ตัวลำโพงแทน (หรือกลับกัน)\n3. หากเป็นเสียง 'จี่' ตลอดเวลา อาจเกิดจากไฟรั่ว ลองเปลี่ยนเต้าเสียบปลั๊ก"
    ], // <-- นี่คือลูกน้ำที่ต้องเติมหลัง Entry สุดท้าย (ลำโพงเสียงแตก)

    // ===== หมวด อุปกรณ์ต่อพ่วง (Keyboard / Mouse) =====
    [
        "keywords" => ["คีย์บอร์ดพิมพ์ไม่ได้", "keyboard ไม่ทํางาน", "พิมพ์ไม่ติด"],
        "solution" => "อาการ: คีย์บอร์ดพิมพ์ไม่ได้\n\nวิธีแก้เบื้องต้น:\n1. (Keyboard USB) ลองถอดสาย USB แล้วเสียบใหม่ หรือเปลี่ยนช่องเสียบ\n2. (Keyboard Wireless) ตรวจสอบถ่าน/แบตเตอรี่ หรือตัวรับสัญญาณ (Dongle)\n3. (โน้ตบุ๊ก) ลอง Restart เครื่อง\n4. ตรวจสอบว่าไม่ได้กดโดนปุ่ม 'Filter Keys' ค้างไว้ (ปุ่ม Shift ขวา ค้าง 8 วิ)"
    ],
    [
        "keywords" => ["เมาส์ไม่ทํางาน", "เมาส์ไม่ขยับ", "คลิกไม่ได้", "เมาส์ค้าง"],
        "solution" => "อาการ: เมาส์ไม่ทำงาน\n\nวิธีแก้เบื้องต้น:\n1. (Mouse USB) ลองถอดสาย USB แล้วเสียบใหม่ หรือเปลี่ยนช่องเสียบ\n2. (Mouse Wireless) ตรวจสอบถ่าน/แบตเตอรี่ หรือตัวรับสัญญาณ (Dongle)\n3. (Mouse Bluetooth) ตรวจสอบว่าเปิด Bluetooth และเชื่อมต่อ (Pair) ถูกต้อง\n4. ลองเปลี่ยนพื้นผิวที่ใช้รองเมาส์ (เช่น ใช้แผ่นรองเมาส์)"
    ],
    [
        "keywords" => ["เมาส์เบิ้ล", "คลิกทีเดียวเบิ้ล", "คลิกเบิ้ล"],
        "solution" => "อาการ: คลิกเมาส์ครั้งเดียว แต่เครื่องทำงานเหมือนดับเบิลคลิก\n\nวิธีแก้เบื้องต้น:\n1. (ใน Windows) ไปที่ Control Panel > Mouse > ปรับความเร็ว 'Double-click speed' ให้ช้าลง\n2. หากยังไม่หาย อาจเป็นที่ฮาร์ดแวร์ (สวิตช์เมาส์) สกปรกหรือเสื่อมสภาพ\n3. ลองสลับปุ่มเมาส์ซ้าย-ขวา (ใน Settings) เพื่อทดสอบว่ายังเป็นที่ปุ่มเดิมหรือไม่"
    ],

    // ===== หมวด กล้องเว็บแคม (Webcam) =====
    [
        "keywords" => ["กล้องไม่ติด", "webcam ไม่ทํางาน", "เปิดกล้องไม่ได้", "ภาพไม่มา"],
        "solution" => "อาการ: เปิดกล้องเว็บแคมไม่ได้ (เช่น ใน LINE, Zoom, Google Meet)\n\nวิธีแก้เบื้องต้น:\n1. ตรวจสอบว่ามีโปรแกรมอื่นเปิดใช้กล้องค้างอยู่หรือไม่ (ให้ปิดโปรแกรมอื่นให้หมด)\n2. (โน้ตบุ๊ก) ตรวจสอบว่าได้กดปุ่มเปิด/ปิดกล้อง (F-Key) หรือมีสวิตช์เลื่อนปิดหน้ากล้องหรือไม่\n3. (กล้อง USB) ลองถอดเสียบใหม่ หรือเปลี่ยนช่อง USB\n4. (ใน Windows) ไปที่ Settings > Privacy > Camera ตรวจสอบว่าอนุญาตให้แอปใช้กล้องแล้ว"
    ],

    // ===== หมวด Software / Windows =====
    [
        "keywords" => ["คอมเปิดช้า", "บูทเครื่องนาน", "เข้า windows ช้า"],
        "solution" => "อาการ: คอมพิวเตอร์/โน้ตบุ๊ก เปิดเครื่องช้ามาก\n\nวิธีแก้เบื้องต้น:\n1. เปิด Task Manager (Ctrl+Shift+Esc) > ไปที่แท็บ 'Startup'\n2. ลอง 'Disable' (ปิด) โปรแกรมที่ไม่จำเป็นต้องเปิดพร้อมเครื่อง (เช่น Spotify, Steam)\n3. (ถ้าใช้ Harddisk จานหมุน) ทำ Disk Defragmenter\n4. สแกนไวรัสและมัลแวร์"
    ],
    [
        "keywords" => ["โปรแกรมเด้ง", "โปรแกรมค้าง", "app-crash", "โปรแกรมปิดเอง", "Not Responding"],
        "solution" => "อาการ: โปรแกรมที่ใช้งานอยู่เด้งปิดตัวเอง หรือค้าง (Not Responding)\n\nวิธีแก้เบื้องต้น:\n1. ลอง Restart เครื่อง\n2. ลองถอนการติดตั้ง (Uninstall) โปรแกรมนั้น แล้วติดตั้งใหม่\n3. อัปเดตโปรแกรมนั้นให้เป็นเวอร์ชันล่าสุด\n4. ตรวจสอบว่า RAM หรือ CPU ทำงานหนักเกินไปหรือไม่ (ผ่าน Task Manager)"
    ],

    // ===== หมวด มือถือ / แท็บเล็ต (Mobile / Tablet) =====
    [
        "keywords" => ["ชาร์จไม่เข้า", "มือถือชาร์จไม่เข้า", "แท็บเล็ตชาร์จไม่ติด"],
        "solution" => "อาการ: มือถือ/แท็บเล็ต ชาร์จไฟไม่เข้า\n\nวิธีแก้เบื้องต้น:\n1. ลองเปลี่ยนสายชาร์จ หรือ อะแดปเตอร์ (หัวชาร์จ)\n2. (สำคัญมาก) ลองทำความสะอาดรูชาร์จที่ตัวเครื่อง (ใช้ไม้จิ้มฟันหรือแปรงค่อยๆ เขี่ยฝุ่นออก)\n3. ลอง Restart เครื่อง\n4. ลองเปลี่ยนเต้าเสียบปลั๊ก"
    ],
    [
        "keywords" => ["มือถือช้า", "เครื่องอืด", "เมมเต็ม", "ความจำเต็ม"],
        "solution" => "อาการ: มือถือ/แท็บเล็ต ทำงานช้า หรือแจ้งว่าความจำเต็ม\n\nวิธีแก้เบื้องต้น:\n1. ลอง Restart เครื่อง\n2. ลบแอปที่ไม่ใช้งาน และลบรูปภาพ/วิดีโอเก่าๆ (หรือ Backup ลง Cloud/คอม)\n3. (Android) ลองเคลียร์ Cache ของแอป (ไปที่ Settings > Apps > เลือกแอป > Storage > Clear Cache)\n4. อัปเดตระบบปฏิบัติการ (iOS/Android) ให้เป็นเวอร์ชันล่าสุด"
    ],
    [
        "keywords" => ["เครื่องค้าง", "ค้าง", "โปรแกรมค้าง", "กดอะไรไม่ได้", "เมาส์ค้าง", "Not Responding"],
        "solution" => "อาการ: เครื่องค้าง / โปรแกรมไม่ตอบสนอง (Not Responding)\n\nวิธีแก้เบื้องต้น (ถ้าค้างแค่โปรแกรมเดียว):\n1. กด `Ctrl + Shift + Esc` พร้อมกันเพื่อเปิด 'Task Manager'\n2. คลิกเลือกโปรแกรมที่ขึ้นว่า (Not Responding)\n3. กดปุ่ม 'End Task' ที่มุมล่างขวาเพื่อบังคับปิดโปรแกรมนั้น\n\nวิธีแก้เบื้องต้น (ถ้าค้างทั้งเครื่อง):\n1. ลองกด `Ctrl + Alt + Delete` พร้อมกัน แล้วเลือก 'Sign out' หรือ 'Restart'\n2. (ถ้าไม่ได้ผล) กดปุ่ม Power (ปุ่มเปิด/ปิดเครื่อง) ค้างไว้ 10 วินาที เพื่อบังคับปิดเครื่อง (Force Shutdown) แล้วรอสักครู่ก่อนเปิดใหม่"
    ]
];

// รับข้อความจาก frontend
$data = json_decode(file_get_contents("php://input"), true);
$userMessage = $data["message"] ?? "";

// ตั้งค่าคำตอบเริ่มต้น
$reply = "ขออภัย ระบบไม่พบวิธีแก้ปัญหาสำหรับอาการนี้ กรุณาลองอธิบายอาการอีกครั้ง หรือติดต่อช่างโดยตรงครับ";
$found = false;

if ($userMessage) {
    // วนลูปค้นหาในฐานข้อมูลความรู้
    foreach ($knowledgeBase as $item) {
        // วนลูปค้นหา Keyword
        foreach ($item["keywords"] as $keyword) {
            
            // ถ้าเจอ Keyword ใดในข้อความของผู้ใช้
            if (str_contains(mb_strtolower($userMessage), mb_strtolower($keyword))) {
                $reply = $item["solution"]; // ได้คำตอบแล้ว
                $found = true;
                break; // หยุดค้นหา keyword
            }
        }
        
        if ($found) {
            break; // หยุดค้นหา เพราะเจอคำตอบแล้ว
        }
    }
} else {
     $reply = "กรุณาบรรยายปัญหาเพื่อให้ระบบช่วยวิเคราะห์ค่ะ";
}

// 3. ส่งคำตอบกลับเป็น JSON
echo json_encode(["reply" => $reply]);

?>